"use client"

import { useState } from "react"
import { WorkPermit } from "@/lib/types/facility"
import { Badge } from "@/components/ui/display"
import { Button } from "@/components/ui/button"

interface PermitApprovalProps {
  permit: WorkPermit
  onApprove: (stage: string, comments?: string, conditions?: string[]) => Promise<void>
  onReject: (stage: string, comments: string) => Promise<void>
  onRequestInfo: (stage: string, comments: string) => Promise<void>
  currentUserRole: string
  canApprove: boolean
}

const approvalStages = [
  { stage: 'safety_review', label: '?àÏ†ÑÍ≤Ä??, role: 'safety_manager', icon: '?õ°Ô∏? },
  { stage: 'technical_review', label: 'Í∏∞Ïà†Í≤Ä??, role: 'technical_manager', icon: '?îß' },
  { stage: 'management_approval', label: 'Í¥ÄÎ¶¨Ïäπ??, role: 'facility_manager', icon: '?ë®?çüí? },
  { stage: 'final_approval', label: 'ÏµúÏ¢Ö?πÏù∏', role: 'plant_manager', icon: '?? }
]

const statusConfig = {
  pending: {
    label: "?ÄÍ∏∞Ï§ë",
    color: "text-text-secondary",
    bg: "bg-background-hover",
    icon: "??
  },
  approved: {
    label: "?πÏù∏??,
    color: "text-success-text",
    bg: "bg-success-bg",
    icon: "??
  },
  rejected: {
    label: "Í±∞Î???,
    color: "text-error-text",
    bg: "bg-error-bg",
    icon: "??
  },
  info_requested: {
    label: "?ïÎ≥¥?îÏ≤≠",
    color: "text-warning-text",
    bg: "bg-warning-bg",
    icon: "??
  }
}

export function PermitApproval({
  permit,
  onApprove,
  onReject,
  onRequestInfo,
  currentUserRole,
  canApprove
}: PermitApprovalProps) {
  const [activeAction, setActiveAction] = useState<{
    type: 'approve' | 'reject' | 'info_request' | null
    stage: string | null
  }>({ type: null, stage: null })
  
  const [comments, setComments] = useState('')
  const [conditions, setConditions] = useState<string[]>([])
  const [newCondition, setNewCondition] = useState('')

  // ?†Ïßú ?¨Îß∑???®Ïàò
  const formatDate = (dateString: string) => {
    const date = new Date(dateString)
    return date.toLocaleString('ko-KR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    })
  }

  // ?ÑÏû¨ ?¨Ïö©?êÍ? ?πÏù∏?????àÎäî ?®Í≥Ñ ?ïÏù∏
  const getCurrentApprovalStage = () => {
    return permit.approvals.find(approval => 
      approval.approverRole === currentUserRole && approval.status === 'pending'
    )
  }

  // ?πÏù∏ ÏßÑÌñâÎ•?Í≥ÑÏÇ∞
  const getApprovalProgress = () => {
    const totalStages = permit.approvals.length
    const completedStages = permit.approvals.filter(approval => 
      approval.status === 'approved'
    ).length
    return totalStages > 0 ? Math.round((completedStages / totalStages) * 100) : 0
  }

  const currentStage = getCurrentApprovalStage()
  const progress = getApprovalProgress()

  const handleAddCondition = () => {
    if (newCondition.trim() && !conditions.includes(newCondition.trim())) {
      setConditions(prev => [...prev, newCondition.trim()])
      setNewCondition('')
    }
  }

  const handleRemoveCondition = (index: number) => {
    setConditions(prev => prev.filter((_, i) => i !== index))
  }

  const handleActionSubmit = async () => {
    if (!activeAction.type || !activeAction.stage) return

    try {
      switch (activeAction.type) {
        case 'approve':
          await onApprove(activeAction.stage, comments || undefined, conditions.length > 0 ? conditions : undefined)
          break
        case 'reject':
          if (!comments.trim()) {
            alert('Í±∞Î? ?¨Ïú†Î•??ÖÎ†•?¥Ï£º?∏Ïöî.')
            return
          }
          await onReject(activeAction.stage, comments)
          break
        case 'info_request':
          if (!comments.trim()) {
            alert('?îÏ≤≠ ?¥Ïö©???ÖÎ†•?¥Ï£º?∏Ïöî.')
            return
          }
          await onRequestInfo(activeAction.stage, comments)
          break
      }

      // Ï¥àÍ∏∞??
      setActiveAction({ type: null, stage: null })
      setComments('')
      setConditions([])
    } catch (error) {
      console.error('?πÏù∏ Ï≤òÎ¶¨ Ï§??§Î•ò:', error)
      alert('Ï≤òÎ¶¨ Ï§??§Î•òÍ∞Ä Î∞úÏÉù?àÏäµ?àÎã§.')
    }
  }

  const handleCancel = () => {
    setActiveAction({ type: null, stage: null })
    setComments('')
    setConditions([])
    setNewCondition('')
  }

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      {/* ?àÍ????ïÎ≥¥ ?§Îçî */}
      <div className="bg-background-secondary rounded-notion-md p-6">
        <div className="flex items-start justify-between mb-4">
          <div>
            <h2 className="text-xl font-bold text-text-primary mb-2">{permit.title}</h2>
            <div className="flex items-center gap-3 text-sm text-text-secondary">
              <span>#{permit.permitNumber}</span>
              <span>??/span>
              <span>{permit.type}</span>
              <span>??/span>
              <span>{permit.location}</span>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <Badge 
              variant={permit.priority === 'critical' ? 'destructive' : 
                     permit.priority === 'high' ? 'warning' : 'secondary'}
            >
              {permit.priority === 'critical' ? 'Í∏¥Í∏â' :
               permit.priority === 'high' ? '?íÏùå' :
               permit.priority === 'medium' ? 'Î≥¥ÌÜµ' : '??ùå'}
            </Badge>
            <Badge 
              variant={permit.status === 'approved' ? 'success' :
                     permit.status === 'rejected' ? 'destructive' : 'secondary'}
            >
              {permit.status === 'approved' ? '?πÏù∏?? :
               permit.status === 'rejected' ? 'Í±∞Î??? :
               permit.status === 'under_review' ? 'Í≤Ä?†Ï§ë' : permit.status}
            </Badge>
          </div>
        </div>

        {/* ?†Ï≤≠???ïÎ≥¥ */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
          <div>
            <div className="text-text-secondary">?†Ï≤≠??/div>
            <div className="font-medium text-text-primary mt-1">{permit.requestedBy.name}</div>
          </div>
          <div>
            <div className="text-text-secondary">Î∂Ä??/div>
            <div className="font-medium text-text-primary mt-1">{permit.requestedBy.department}</div>
          </div>
          <div>
            <div className="text-text-secondary">?ëÏóÖÍ∏∞Í∞Ñ</div>
            <div className="font-medium text-text-primary mt-1">
              {formatDateTime(permit.startDate)} ~ {formatDateTime(permit.endDate)}
            </div>
          </div>
          <div>
            <div className="text-text-secondary">?àÏÉÅ?úÍ∞Ñ</div>
            <div className="font-medium text-text-primary mt-1">{permit.estimatedDuration}?úÍ∞Ñ</div>
          </div>
        </div>

        {/* ?πÏù∏ ÏßÑÌñâÎ•?*/}
        <div className="mt-4">
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm font-medium text-text-primary">?πÏù∏ ÏßÑÌñâÎ•?/span>
            <span className="text-sm font-medium text-text-primary">{progress}%</span>
          </div>
          <div className="w-full h-3 bg-background-hover rounded-full overflow-hidden">
            <div 
              className="h-full bg-primary rounded-full transition-all duration-300"
              style={{ width: `${progress}%` }}
            />
          </div>
        </div>
      </div>

      {/* ?πÏù∏ ?®Í≥Ñ */}
      <div className="bg-background-secondary rounded-notion-md p-6">
        <h3 className="text-lg font-semibold text-text-primary mb-4">?πÏù∏ ?®Í≥Ñ</h3>
        
        <div className="space-y-4">
          {permit.approvals.map((approval, index) => {
            const stageInfo = approvalStages.find(s => s.stage === approval.stage)
            const statusInfo = statusConfig[approval.status] || statusConfig.pending
            const isCurrentUserStage = approval.approverRole === currentUserRole && approval.status === 'pending'
            const isActive = activeAction.stage === approval.stage
            
            return (
              <div key={index} className={`border rounded-notion-md p-4 ${
                isCurrentUserStage ? 'border-primary bg-primary-light' : 
                approval.status === 'approved' ? 'border-success bg-success-bg' :
                approval.status === 'rejected' ? 'border-error bg-error-bg' :
                'border-border bg-background'
              }`}>
                <div className="flex items-start justify-between">
                  <div className="flex items-start gap-3">
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center ${statusInfo.bg}`}>
                      <span className="text-lg">{stageInfo?.icon || '?ìã'}</span>
                    </div>
                    <div className="flex-1">
                      <h4 className="font-semibold text-text-primary flex items-center gap-2">
                        {stageInfo?.label || approval.stage}
                        <Badge className={`${statusInfo.bg} ${statusInfo.color}`}>
                          <span className="mr-1">{statusInfo.icon}</span>
                          {statusInfo.label}
                        </Badge>
                      </h4>
                      <div className="text-sm text-text-secondary mt-1">
                        ?¥Îãπ?? {approval.approverName || `${approval.approverRole} (ÎØ∏Î∞∞??`}
                      </div>
                      
                      {approval.comments && (
                        <div className="mt-2 p-3 bg-background rounded-notion-sm">
                          <div className="text-sm font-medium text-text-primary mb-1">?òÍ≤¨:</div>
                          <div className="text-sm text-text-secondary">{approval.comments}</div>
                        </div>
                      )}
                      
                      {approval.conditions && approval.conditions.length > 0 && (
                        <div className="mt-2">
                          <div className="text-sm font-medium text-text-primary mb-1">?πÏù∏ Ï°∞Í±¥:</div>
                          <ul className="space-y-1">
                            {approval.conditions.map((condition, condIndex) => (
                              <li key={condIndex} className="text-sm text-warning-text bg-warning-bg px-2 py-1 rounded">
                                ??{condition}
                              </li>
                            ))}
                          </ul>
                        </div>
                      )}
                      
                      {approval.date && (
                        <div className="text-xs text-text-tertiary mt-2">
                          {approval.status === 'approved' ? '?πÏù∏?ºÏãú' : 
                           approval.status === 'rejected' ? 'Í±∞Î??ºÏãú' : 'Ï≤òÎ¶¨?ºÏãú'}: {formatDate(approval.date)}
                        </div>
                      )}
                    </div>
                  </div>

                  {/* ?°ÏÖò Î≤ÑÌäº */}
                  {isCurrentUserStage && canApprove && (
                    <div className="flex items-center gap-2 ml-4">
                      <Button
                        size="sm"
                        onClick={() => setActiveAction({ type: 'approve', stage: approval.stage })}
                        className="bg-success hover:bg-success/90"
                      >
                        ?πÏù∏
                      </Button>
                      <Button
                        size="sm"
                        variant="destructive"
                        onClick={() => setActiveAction({ type: 'reject', stage: approval.stage })}
                      >
                        Í±∞Î?
                      </Button>
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => setActiveAction({ type: 'info_request', stage: approval.stage })}
                      >
                        ?ïÎ≥¥?îÏ≤≠
                      </Button>
                    </div>
                  )}
                </div>

                {/* ?°ÏÖò ??*/}
                {isActive && (
                  <div className="mt-4 p-4 bg-background rounded-notion-md border border-border">
                    <h5 className="font-medium text-text-primary mb-3">
                      {activeAction.type === 'approve' ? '?πÏù∏ Ï≤òÎ¶¨' :
                       activeAction.type === 'reject' ? 'Í±∞Î? Ï≤òÎ¶¨' : '?ïÎ≥¥ ?îÏ≤≠'}
                    </h5>

                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium text-text-primary mb-2">
                          {activeAction.type === 'approve' ? '?πÏù∏ ?òÍ≤¨ (?†ÌÉù?¨Ìï≠)' :
                           activeAction.type === 'reject' ? 'Í±∞Î? ?¨Ïú† (?ÑÏàò)' : '?îÏ≤≠ ?¥Ïö© (?ÑÏàò)'}
                        </label>
                        <textarea
                          value={comments}
                          onChange={(e) => setComments(e.target.value)}
                          className="w-full px-3 py-2 rounded-notion-sm border border-border bg-background-secondary focus:border-border-focus focus:outline-none h-24 resize-none"
                          placeholder={
                            activeAction.type === 'approve' ? '?πÏù∏ ?òÍ≤¨?¥ÎÇò Ï∞∏Í≥†?¨Ìï≠???ÖÎ†•?òÏÑ∏??..' :
                            activeAction.type === 'reject' ? 'Í±∞Î? ?¨Ïú†Î•?Î™ÖÌôï???ÖÎ†•?òÏÑ∏??..' :
                            'Ï∂îÍ?Î°??ÑÏöî???ïÎ≥¥???úÎ•òÎ•??îÏ≤≠?òÏÑ∏??..'
                          }
                        />
                      </div>

                      {/* ?πÏù∏ Ï°∞Í±¥ (?πÏù∏ ?úÎßå) */}
                      {activeAction.type === 'approve' && (
                        <div>
                          <label className="block text-sm font-medium text-text-primary mb-2">
                            ?πÏù∏ Ï°∞Í±¥ (?†ÌÉù?¨Ìï≠)
                          </label>
                          <div className="space-y-2">
                            {conditions.map((condition, condIndex) => (
                              <div key={condIndex} className="flex items-center justify-between p-2 bg-warning-bg rounded-notion-sm">
                                <span className="text-sm text-warning-text">??{condition}</span>
                                <button
                                  type="button"
                                  onClick={() => handleRemoveCondition(condIndex)}
                                  className="text-error-text hover:text-error text-sm"
                                >
                                  ??
                                </button>
                              </div>
                            ))}
                            <div className="flex gap-2">
                              <input
                                type="text"
                                value={newCondition}
                                onChange={(e) => setNewCondition(e.target.value)}
                                className="flex-1 px-3 py-2 rounded-notion-sm border border-border bg-background-secondary focus:border-border-focus focus:outline-none text-sm"
                                placeholder="?πÏù∏ Ï°∞Í±¥???ÖÎ†•?òÏÑ∏??.."
                                onKeyPress={(e) => {
                                  if (e.key === 'Enter') {
                                    e.preventDefault()
                                    handleAddCondition()
                                  }
                                }}
                              />
                              <Button
                                type="button"
                                size="sm"
                                onClick={handleAddCondition}
                              >
                                Ï∂îÍ?
                              </Button>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>

                    <div className="flex items-center justify-end gap-2 mt-4">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={handleCancel}
                      >
                        Ï∑®ÏÜå
                      </Button>
                      <Button
                        size="sm"
                        onClick={handleActionSubmit}
                        className={
                          activeAction.type === 'approve' ? 'bg-success hover:bg-success/90' :
                          activeAction.type === 'reject' ? 'bg-error hover:bg-error/90' :
                          'bg-warning hover:bg-warning/90'
                        }
                      >
                        {activeAction.type === 'approve' ? '?πÏù∏ ?ÑÎ£å' :
                         activeAction.type === 'reject' ? 'Í±∞Î? ?ïÏ†ï' : '?ïÎ≥¥ ?îÏ≤≠'}
                      </Button>
                    </div>
                  </div>
                )}
              </div>
            )
          })}
        </div>
      </div>

      {/* ?àÍ????ÅÏÑ∏ ?ïÎ≥¥ ÎØ∏Î¶¨Î≥¥Í∏∞ */}
      <div className="bg-background-secondary rounded-notion-md p-6">
        <h3 className="text-lg font-semibold text-text-primary mb-4">?àÍ????ÅÏÑ∏ ?ïÎ≥¥</h3>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h4 className="font-medium text-text-primary mb-2">?ëÏóÖ ?§Î™Ö</h4>
            <p className="text-sm text-text-secondary bg-background p-3 rounded-notion-sm">
              {permit.description}
            </p>
          </div>

          <div>
            <h4 className="font-medium text-text-primary mb-2">?ÑÌóò???âÍ?</h4>
            <div className="space-y-2">
              <div className={`inline-flex items-center px-3 py-1 rounded-md text-sm ${
                permit.hazards.riskLevel === 'critical' ? 'bg-red-100 text-red-800' :
                permit.hazards.riskLevel === 'high' ? 'bg-error-bg text-error-text' :
                permit.hazards.riskLevel === 'medium' ? 'bg-warning-bg text-warning-text' :
                'bg-success-bg text-success-text'
              }`}>
                ?ÑÌóò?? {permit.hazards.riskLevel === 'critical' ? 'Í∏¥Í∏â' :
                        permit.hazards.riskLevel === 'high' ? '?íÏùå' :
                        permit.hazards.riskLevel === 'medium' ? 'Î≥¥ÌÜµ' : '??ùå'}
              </div>
              {permit.hazards.identified.length > 0 && (
                <div className="text-sm text-text-secondary">
                  <strong>?ùÎ≥Ñ???ÑÌóò:</strong> {permit.hazards.identified.join(', ')}
                </div>
              )}
            </div>
          </div>

          {permit.safety.requiredPPE.length > 0 && (
            <div>
              <h4 className="font-medium text-text-primary mb-2">?ÑÏöî??Î≥¥Ìò∏Íµ?/h4>
              <div className="flex flex-wrap gap-1">
                {permit.safety.requiredPPE.map((ppe, index) => (
                  <span key={index} className="inline-block px-2 py-1 bg-primary-light text-primary text-xs rounded-md">
                    {ppe}
                  </span>
                ))}
              </div>
            </div>
          )}

          <div>
            <h4 className="font-medium text-text-primary mb-2">?àÏ†Ñ ?îÍµ¨?¨Ìï≠</h4>
            <div className="space-y-1 text-sm">
              {permit.safety.fireWatchRequired && (
                <div className="flex items-center gap-2 text-error-text">
                  <span>?î•</span>
                  <span>?îÏû¨Í∞êÏãú???ÑÏöî</span>
                </div>
              )}
              {permit.safety.gasTestRequired && (
                <div className="flex items-center gap-2 text-warning-text">
                  <span>?ß™</span>
                  <span>Í∞Ä?§Ï∏°???ÑÏöî</span>
                </div>
              )}
              {permit.safety.isolationRequired && (
                <div className="flex items-center gap-2 text-primary">
                  <span>?îí</span>
                  <span>Í≤©Î¶¨Ï°∞Ïπò ?ÑÏöî</span>
                </div>
              )}
              {!permit.safety.fireWatchRequired && !permit.safety.gasTestRequired && !permit.safety.isolationRequired && (
                <div className="text-text-secondary">?πÎ≥Ñ???àÏ†Ñ ?îÍµ¨?¨Ìï≠ ?ÜÏùå</div>
              )}
            </div>
          </div>
        </div>

        {permit.contractor && (
          <div className="mt-4 p-4 bg-background rounded-notion-sm">
            <h4 className="font-medium text-text-primary mb-2">?∏Ï£º?ÖÏ≤¥ ?ïÎ≥¥</h4>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
              <div>
                <div className="text-text-secondary">?ÖÏ≤¥Î™?/div>
                <div className="font-medium text-text-primary">{permit.contractor.companyName}</div>
              </div>
              <div>
                <div className="text-text-secondary">?¥Îãπ??/div>
                <div className="font-medium text-text-primary">{permit.contractor.contactPerson}</div>
              </div>
              <div>
                <div className="text-text-secondary">?∞ÎùΩÏ≤?/div>
                <div className="font-medium text-text-primary">{permit.contractor.contact}</div>
              </div>
              <div>
                <div className="text-text-secondary">Î≥¥Ìóò Í∞Ä??/div>
                <div className={`font-medium ${permit.contractor.insurance ? 'text-success-text' : 'text-error-text'}`}>
                  {permit.contractor.insurance ? '??Í∞Ä?? : '??ÎØ∏Í???}
                </div>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* ?ÑÏû¨ ?¨Ïö©???ÅÌÉú ?àÎÇ¥ */}
      {canApprove && (
        <div className="bg-primary-light rounded-notion-md p-4 text-center">
          {currentStage ? (
            <div>
              <div className="text-lg font-semibold text-primary mb-1">
                ?πÏù∏ ?ÄÍ∏?Ï§ëÏù∏ ?®Í≥ÑÍ∞Ä ?àÏäµ?àÎã§
              </div>
              <div className="text-sm text-primary">
                {approvalStages.find(s => s.stage === currentStage.stage)?.label} ?®Í≥Ñ?êÏÑú Í∑Ä?òÏùò ?πÏù∏??Í∏∞Îã§Î¶¨Í≥† ?àÏäµ?àÎã§.
              </div>
            </div>
          ) : (
            <div>
              <div className="text-sm text-text-secondary">
                ?ÑÏû¨ Í∑Ä?òÍ? ?πÏù∏?????àÎäî ?®Í≥ÑÍ∞Ä ?ÜÏäµ?àÎã§.
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  )
}